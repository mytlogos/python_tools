{% extends "./base_generic.html" %}
{% load static %}
{% block content %}
    {% csrf_token %}
    <style>
        #states {
            max-width: 200px;
        }

        #states > * {
            margin: 5px;
        }

        .tab-content {
            animation: fadeEffect 1s; /* Fading effect takes 1 second */
            display: none;
            padding: 6px 12px;
        }

        .tab-content.active {
            display: block;
        }

        /* Go from zero to full opacity */
        @keyframes fadeEffect {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .work-container {
            margin: 5px;
        }

        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
    <div class="buttons">
        <div id="process_state" class="button is-primary">Start</div>
        <a href="{% url 'polls:create-task' %}">
            <button class="button">New</button>
        </a>
    </div>
    <div class="columns">
        <div id="states" class="container column is-one-quarter">
            <figure class="image is-square">
                <div class="button has-ratio">
                    Text Extracting
                </div>
            </figure>
            <div class="is-flex is-horizontal-center">
                <img src="{% static "polls/images/arrow-down.svg" %}" alt="Arrow Down"/>
            </div>
            <figure class="image is-square">
                <div class="button has-ratio">
                    Text Processing
                </div>
            </figure>
            <div class="is-flex is-horizontal-center">
                <img src="{% static "polls/images/arrow-down.svg" %}" alt="Arrow Down"/>
            </div>
            <figure class="image is-square">
                <div class="button has-ratio">
                    Calculate Similarity
                </div>
            </figure>
        </div>
        <div class="container column">
            <div class="tabs is-medium">
                <ul>
                    <li class="is-active">
                        <a>
                            <span class="icon is-small"><i class="fas fa-cog" aria-hidden="true"></i></span><span>Settings</span>
                        </a>
                    </li>
                    <li>
                        <a>
                        <span class="icon is-small"><i class="fas fa-cogs"
                                                       aria-hidden="true"></i></span><span>Process</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="tab-content active">
                <div>
                    <label>
                        Processes:
                        <input id="process-number" type="number" value="1">
                    </label>
                </div>
            </div>
            <div class="tab-content">
                <label>Current Work Progress</label>
                <progress id="process-progress"></progress>
                <label id="process-progress-label"></label>
                <div class="is-flex stage-container">
                    <div class="work-container">
                        <div class="work-stage">Stage:</div>
                        <div class="work-current">Current:</div>
                        <div class="work-total">Total:</div>
                        <div class="work-state">State:</div>
                        <div class="work-start">Start:</div>
                        <div class="work-end">End:</div>
                        <div class="work-running">Time Running:</div>
                        <div class="work-estimated">Time Left:</div>
                    </div>
                </div>
                <p id="output"></p>
            </div>
            <template class="stage-template">
                <div class="work-container">
                    <div class="work-stage">Unknown</div>
                    <div class="work-current">Unknown</div>
                    <div class="work-total">Unknown</div>
                    <div class="work-state">Unknown</div>
                    <div class="work-start">Unknown</div>
                    <div class="work-end">Unknown</div>
                    <div class="work-running">Unknown</div>
                    <div class="work-estimated">Unknown</div>
                </div>
            </template>
        </div>
    </div>
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
        const tabs = document.querySelectorAll(".tabs li")
        const tabContents = document.querySelectorAll(".tab-content")

        for (let i = 0; i < tabs.length; i++) {
            /**
             *
             * @type {Element}
             */
            const tabHeader = tabs[i]
            tabHeader.addEventListener("click", () => {
                const activeTab = document.querySelector(".tabs li.is-active")
                const index = Array.prototype.indexOf.call(tabs, activeTab);

                const previousContents = tabContents[index];
                previousContents.classList.remove("active");
                activeTab.classList.remove("is-active");

                const nextContents = tabContents[i];
                nextContents.classList.add("active");
                tabHeader.classList.add("is-active");
            });
        }
        let intervalId;
        let running = {{ task.is_running|yesno:"true,false" }};

        if (running) {
            intervalId = setInterval(queryState, 5000)
        }
        const outputNode = document.querySelector("#output");
        const stageContainer = document.querySelector(".stage-container");
        const stageNodes = {};
        /**
         * @type {HTMLTemplateElement}
         */
        const stageTemplate = document.querySelector(".stage-template")

        /**
         * @type {HTMLElement}
         */
        const processStateButton = document.querySelector("#process_state");

        processStateButton.addEventListener("click", async () => {
            clearInterval(intervalId);
            try {
                const url = `http://localhost:8000/polls/api/${running ? "stop" : "start"}/{{ task.pk }}/`;
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    mode: "same-origin",
                    body: JSON.stringify(getConfig())
                });
                running = !running;
                processStateButton.textContent = running ? "Stop" : "Start";

                if (running) {
                    intervalId = setInterval(queryState, 5000);
                }
                const value = await response.json();
                appendLine(outputNode, value);
            } catch (e) {
                appendLine(outputNode, e)
            }
        });

        function getConfig() {
            /**
             * @type {HTMLInputElement}
             */
            const processNumberInput = document.getElementById("process-number");
            return {
                processes: processNumberInput.valueAsNumber || 1
            }
        }

        async function queryState() {
            try {
                const response = await fetch("http://localhost:8000/polls/api/progress/{{ task.pk }}/");

                if (!response.ok) {
                    return;
                }
                const msg = await response.json();

                for (const message of msg) {
                    if (message.running === false) {
                        running = false;
                        clearInterval(intervalId);
                    }
                    if (message.name) {
                        processMessage(message);
                    }
                }
            } catch (reason) {
                clearInterval(intervalId);
                console.log("threw something: ", reason);
                appendLine(outputNode, reason);
            }
            /**
             * @type {HTMLProgressElement}
             */
            const progressElement = document.querySelector("#process-progress");
            const progressLabel = document.querySelector("#process-progress-label");
            let total = 0;
            let current = 0;

            for (const value of Object.values(stageProgress)) {
                total += value.total;
                current += value.current;
            }
            progressElement.max = total;
            progressElement.value = current;
            progressLabel.textContent = `${current}/${total}`
            processStateButton.textContent = running ? "Stop" : "Start";
            console.log(stageProgress);
        }

        const currentSuffix = "_current";
        const totalSuffix = "_total";
        const stageProgress = {};

        /**
         * @typedef ProgressMessage
         * @property {string} name
         * @property {number} current
         * @property {number} total
         * @property {string} state
         * @property {Date} start_time
         * @property {Date} end_time
         * @property {number | undefined} time_left
         */

        /**
         * @param {ProgressMessage} message - current stage progress
         */
        function processMessage(message) {
            stageProgress[message.name] = message;
            /**
             * @type {HTMLElement}
             */
            let node = stageNodes[message.name];

            if (!node) {
                stageNodes[message.name] = node = stageTemplate.cloneNode(true).content.firstElementChild;
                stageContainer.appendChild(node);
            }
            message.start_time = message.start_time && new Date(message.start_time);
            message.end_time = message.end_time && new Date(message.end_time);
            const now = new Date()

            node.querySelector(".work-stage").textContent = message.name;
            node.querySelector(".work-current").textContent = message.current + "";
            node.querySelector(".work-total").textContent = message.total + "";
            node.querySelector(".work-state").textContent = message.state;
            node.querySelector(".work-end").textContent = message.end_time + "";
            node.querySelector(".work-start").textContent = message.start_time + "";

            if (message.start_time) {
                const startTime = new Date(message.start_time);
                const millisecondsRunning = now - startTime;
                node.querySelector(".work-running").textContent = toTime(millisecondsRunning, false);

                // prevent division by zero, and we can only estimate if at least one step was done
                if (message.total && message.current) {
                    const progress = message.current / message.total;
                    const msecsLeft = (millisecondsRunning / progress) * (1 - progress);
                    message.time_left = msecsLeft;
                    node.querySelector(".work-estimated").textContent = toTime(msecsLeft, false);
                }
            }
        }

        setInterval(updateTime, 1000)

        function updateTime() {
            if (!running) {
                return;
            }
            for (const [key, message] of Object.entries(stageProgress)) {
                /**
                 * @type {HTMLElement}
                 */
                const node = stageNodes[key];

                if (!node) {
                    continue;
                }
                if (message.time_left) {
                    message.time_left -= 1000;
                    try {
                        node.querySelector(".work-estimated").textContent = toTime(message.time_left, false);
                    } catch (e) {
                        console.log(message.time_left, e)
                    }
                }
            }
        }

        /**
         * Copied from https://stackoverflow.com/a/35890816
         *
         * @param {number} value
         * @param {boolean | undefined} isSec
         */
        function toTime(value, isSec) {
            const ms = isSec ? value * 1e3 : value;
            const lm = ~(4 * !!isSec);  /* limit fraction */
            const fmt = new Date(ms).toISOString().slice(11, lm);

            if (ms >= 8.64e7) {  /* >= 24 hours */
                const parts = fmt.split(/:(?=\d{2}:)/);
                parts[0] -= -24 * (ms / 8.64e7 | 0);
                return parts.join(':');
            }

            return fmt;
        }

        /**
         *
         * @param {Element} node
         * @param {object} value
         */
        function appendLine(node, value) {
            if (value.stage !== undefined) {
                value = value.message || value.msg;
            }
            node.insertAdjacentText("beforeend", JSON.stringify(value).slice(0, 200));
            node.appendChild(document.createElement("br"));
        }
    </script>
{% endblock %}